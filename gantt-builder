<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PwC Project Planner</title>
  <style>
    :root{
      --bg: #ffffff;
      --panel: #f8f8f9;
      --panel-2: #f0f1f3;
      --text: #1a1a1a;
      --muted: #6b7280;
      --border: #DFE3E6;
      --accent: #FD5108;

      --bar-task: #FD5108;
      --bar-summary: #6b7280;
      --bar-milestone: #E84000;

      --danger: #ef4444;
      --ok: #22c55e;

      --day-width: 24px;
      --row-height: 36px;
      --left-width: 580px;
      --header-height: 56px;
      --font: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    html, body { height: 100%; background: #ffffff; color: var(--text); margin: 0; font-family: var(--font); }
    * { box-sizing: border-box; }

    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
    }
    .toolbar .group { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1; }

    button, input, select {
      font-family: var(--font);
      font-size: 14px;
    }

    button {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      border-radius: 2px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    button:hover { border-color: #B5BCC4; background: #f0f1f3; }
    button.primary { background: #FFAA72; color: #000; border-color: #FFAA72; }
    button.primary:hover { background: #f09a5e; border-color: #f09a5e; }
    button.danger { background: transparent; color: var(--danger); border-color: var(--danger); }
    button.danger:hover { background: #FEE2E2; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px; border-radius: 999px;
      border: 1px solid var(--border);
      background: #f0f1f3;
      color: #4b5563;
      font-size: 12px;
      white-space: nowrap;
    }
    .pill strong { color: var(--text); font-weight: 600; }

    .range {
      display:flex; align-items:center; gap:8px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #f0f1f3;
      color: var(--muted);
    }
    .range input[type="range"] { width: 170px; accent-color: var(--accent); }

    .layout {
      flex: 1;
      min-height: 0;
      display: flex;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      background: var(--panel);
    }

    .brand { display:flex; align-items:center; gap:12px; }
    .brand-title { font-size:16px; font-weight:700; color:#1a1a1a; }
    .brand-divider { width:1px; height:28px; background:#DFE3E6; margin:0 4px; }

    .scenario-bar {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 14px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      font-size: 13px;
    }
    .scenario-bar label { font-weight: 600; color: var(--text); white-space: nowrap; }
    .scenario-bar select { flex: 1; max-width: 360px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; background: #fff; font-family: var(--font); font-size: 13px; }

    /* Left */
    .left {
      width: var(--left-width);
      min-width: 280px;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--panel-2);
    }
    .left-header {
      height: var(--header-height);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 3;
      background: var(--panel-2);
    }
    .left-header .title { font-weight: 650; }
    .left-body {
      flex: 1;
      min-height: 0;
      overflow: auto;
    }

    .task-row {
      height: var(--row-height);
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 4px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: relative;
    }
    .task-row:hover { background: rgba(0,0,0,0.02); }
    .task-row.selected { outline: 2px solid rgba(253,81,8,0.25); outline-offset: -2px; background: rgba(253,81,8,0.06); }

    .twisty {
      width: 22px; height: 22px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }
    .twisty.hidden { visibility: hidden; }

    .name {
      flex: 1;
      min-width: 0;
      display:flex;
      align-items:center;
      gap: 6px;
      overflow: hidden;
    }
    .name .label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 60px;
      cursor: default;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #f0f1f3;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .badge.summary { color: #374151; border-color: #CBD1D6; }
    .badge.milestone { color: #E84000; border-color: #FFAA72; }

    .dates {
      display:flex;
      align-items:center;
      gap: 6px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .dates input[type="date"]{
      background: #ffffff;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 4px 4px;
      width: 110px;
      font-size: 11px;
    }
    .dates input[type="date"]:disabled{ opacity: 0.5; }

    .row-actions {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display:flex; align-items:center; gap: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
      background: var(--panel-2);
      padding: 2px 4px;
      border-radius: 4px;
      z-index: 2;
    }
    .task-row:hover .row-actions {
      opacity: 1;
      pointer-events: auto;
    }
    .icon-btn{
      width: 30px; height: 30px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 4px;
      padding: 0;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    .icon-btn:hover { border-color: #B5BCC4; background: #f0f1f3; }
    .icon-btn.danger { border-color: var(--danger); background: #FEE2E2; }

    /* Right */
    .right {
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction: column;
      background: var(--panel);
    }
    .right-header {
      height: var(--header-height);
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 2;
      overflow: hidden;
    }
    .timeline-header {
      height: 100%;
      position: relative;
      display: grid;
      grid-template-rows: 1fr 1fr;
      align-items: stretch;
      white-space: nowrap;
      transform: translateZ(0);
    }
    .months, .days {
      display:flex;
      height: 100%;
    }
    .month-cell, .day-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      border-right: 1px solid rgba(0,0,0,0.08);
      color: var(--muted);
      font-size: 12px;
      padding: 0 6px;
      user-select: none;
    }
    .month-cell { font-weight: 650; color: #1a1a1a; }
    .day-cell { font-variant-numeric: tabular-nums; }

    .right-body {
      flex: 1;
      min-height: 0;
      overflow: auto; /* both axes */
      position: relative;
    }

    .timeline {
      position: relative;
      width: var(--timeline-width);
      height: var(--timeline-height);
      background:
        linear-gradient(to right, rgba(0,0,0,0.06) 1px, transparent 1px),
        linear-gradient(to right, rgba(0,0,0,0.12) 1px, transparent 1px);
      background-size: var(--day-width) 100%, calc(var(--day-width) * 7) 100%;
      background-position: 0 0, 0 0;
    }
    .timeline .row {
      height: var(--row-height);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: relative;
    }
    .row .bar {
      position: absolute;
      top: 8px;
      height: 20px;
      border-radius: 4px;
      background: var(--bar-task);
      border: 1px solid rgba(0,0,0,0.12);
      cursor: grab;
      display:flex;
      align-items:center;
      padding: 0 8px;
      min-width: 6px;
      user-select: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 12px;
      color: #ffffff;
      z-index: 1;
      transform: translateZ(0);
    }
    .row .bar.summary {
      background: var(--bar-summary);
      color: #ffffff;
      cursor: default;
      opacity: 0.9;
    }
    .row .bar.milestone {
      width: 0;
      height: 0;
      top: 8px;
      background: transparent;
      border: none;
      padding: 0;
      cursor: grab;
    }
    .row .bar.milestone::before{
      content:"";
      display:block;
      width: 14px;
      height: 14px;
      transform: rotate(45deg);
      background: var(--bar-milestone);
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.15);
    }

    .handle {
      position:absolute;
      top: 0;
      width: 10px;
      height: 100%;
      cursor: ew-resize;
    }
    .handle.left { left: -2px; }
    .handle.right { right: -2px; }

    .today-line {
      position: absolute;
      top: 0;
      width: 2px;
      height: var(--timeline-height);
      background: rgba(239,68,68,0.65);
      z-index: 3;
      pointer-events: none;
    }

    .deps {
      position: absolute;
      left: 0;
      top: 0;
      width: var(--timeline-width);
      height: var(--timeline-height);
      pointer-events: none;
      z-index: 2;
    }
    .deps path {
      stroke: rgba(0,0,0,0.35);
      stroke-width: 1.5;
      fill: none;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 50;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(720px, 100%);
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 15px 60px rgba(0,0,0,0.55);
    }
    .modal header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: var(--panel-2);
    }
    .modal header .h { font-weight: 700; }
    .modal .body { padding: 14px; display:grid; gap: 12px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field { display:grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input[type="text"], .field select, .field input[type="date"], .field textarea {
      background: #ffffff;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 9px 10px;
      width: 100%;
    }
    .field textarea { min-height: 70px; resize: vertical; }
    .field select[multiple] { height: 120px; }

    .rowline {
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .help {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .modal footer{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: var(--panel-2);
    }

    /* Print */
    @media print {
      body { background: #ffffff !important; color: #000 !important; }
      .app { padding: 0; gap: 0; }
      .toolbar { display: none !important; }
      .scenario-bar { display: none !important; }
      .layout { border: none; border-radius: 0; }
      .left { width: 420px; }
      .left, .right { background: #fff !important; color: #000 !important; }
      .left-header, .right-header { background: #fff !important; position: static; }
      .task-row, .timeline .row { border-bottom: 1px solid #ddd !important; }
      .month-cell, .day-cell { border-right: 1px solid #ddd !important; color: #222 !important; }
      .deps path { stroke: #444 !important; }
      .row .bar { border: 1px solid rgba(0,0,0,0.2) !important; }
      .row-actions { display: none !important; }
    }

    /* Tablet */
    @media (max-width: 1200px){
      :root { --left-width: 480px; }
      .dates input[type="date"]{ width: 100px; }
      .icon-btn { width: 26px; height: 26px; }
    }
    /* Small tablet */
    @media (max-width: 960px){
      :root { --left-width: 380px; }
      .dates { display: none; }
      .grid2 { grid-template-columns: 1fr; }
    }
    /* Mobile */
    @media (max-width: 700px){
      :root { --left-width: 260px; }
      .dates { display: none; }
      .badge { display: none; }
      .brand-title { display: none; }
      .toolbar .group { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <div class="brand">
        <svg width="68" height="32" viewBox="30 143 440 212" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M355.041 233.765C339.717 236.206 331.925 247.425 331.925 267.214C331.925 287.003 342.331 300.403 358.334 300.403C365.762 300.403 372.508 297.962 386.732 291.054V307.155C369.682 314.894 359.642 317.335 345.94 317.335C331.088 317.335 320.629 313.44 312.052 304.766C303.319 296.092 298.926 284.561 298.926 271.784C298.926 243.322 320.158 224.104 351.118 224.104C371.67 224.104 385.842 233.453 385.842 247.165C385.842 255.995 379.252 262.072 369.473 262.072C364.454 262.072 360.323 260.773 355.041 257.709V233.869V233.765ZM279.472 271.732C293.173 254.54 298.037 247.632 298.037 239.166C298.037 230.7 291.343 224 282.348 224C276.805 224 271.837 226.597 269.431 229.298V264.305L246.944 294.066V226.234H225.555L190.045 284.717V226.234H177.756L145.489 234.024V242.231L163.061 243.997V315.725H185.809L219.907 260.098V315.725H244.8L279.42 271.732H279.472ZM77.6086 244.464C82.8381 243.841 85.4532 243.529 87.9111 243.529C102.763 243.529 110.764 253.294 110.764 271.732C110.764 293.495 100.933 304.818 82.6291 304.818C81.1125 304.818 80.0143 304.818 77.6086 304.714V244.464ZM77.6086 314.894C83.518 315.569 89.2708 315.777 92.7223 315.777C123.211 315.777 142.508 296.404 142.508 267.629C142.508 242.75 128.022 224.727 108.359 224.727C99.8346 224.727 94.1867 226.441 77.6086 236.258V224.26H68.4046L33 234.959V243.581H47.6429V343.928L34.4643 347.2V355.511H92.304V347.2L77.5564 343.928V314.894H77.6086Z" fill="currentColor"/>
          <path d="M338.568 199.173H242.029L258.45 172.112H354.99L338.568 199.173ZM468 145H371.463L355.042 172.06H451.579L468 145Z" fill="#FD5108"/>
        </svg>
        <span class="brand-title">Project Planner</span>
      </div>
      <div class="brand-divider"></div>
      <div class="group">
        <button class="primary" id="btnAdd">Add</button>
        <button id="btnSaveLocal">Save</button>
        <button id="btnLoadLocal">Load</button>
        <button id="btnExportJson">Export JSON</button>
        <label class="pill" style="cursor:pointer;">
          <strong>Import JSON</strong>
          <input id="fileImport" type="file" accept=".json,application/json" style="display:none;">
        </label>
        <button id="btnExportPng">Export PNG</button>
        <button id="btnExportSvg">Export SVG</button>
        <button id="btnExportExcel">Export Excel</button>
        <button id="btnPrint">Print / PDF</button>
      </div>
      <div class="spacer"></div>
      <div class="group">
        <div class="range" title="Timeline scale (pixels per day)">
          <span>Zoom</span>
          <input id="zoom" type="range" min="14" max="44" step="2" value="24">
          <span class="pill"><strong id="zoomVal">24</strong> px/day</span>
        </div>
        <div class="range" title="Left panel width">
          <span>Left</span>
          <input id="leftWidth" type="range" min="280" max="900" step="10" value="580">
          <span class="pill"><strong id="leftWidthVal">580</strong> px</span>
        </div>
        <button class="danger" id="btnClear">Clear</button>
      </div>
    </div>

    <div class="scenario-bar">
      <label>Load Scenario:</label>
      <select id="scenarioSelect">
        <option value="">â€” Select a project template â€”</option>
        <option value="tech-transformation">Technology Transformation</option>
        <option value="operating-model">Operating Model Redesign</option>
        <option value="ma-integration">M&amp;A Integration</option>
        <option value="finance-transformation">Finance Transformation</option>
        <option value="cyber-assessment">Cybersecurity Assessment</option>
        <option value="people-change">People &amp; Organisation Change</option>
        <option value="data-analytics">Data &amp; Analytics Strategy</option>
        <option value="regulatory-compliance">Regulatory Compliance Programme</option>
      </select>
      <button id="btnLoadScenario" class="primary">Load</button>
    </div>

    <div class="layout">
      <div class="left">
        <div class="left-header">
          <div class="title">Project Plan</div>
          <div class="pill">Drag bars to adjust dates Â· Double-click to edit names</div>
        </div>
        <div class="left-body" id="leftBody"></div>
      </div>

      <div class="right">
        <div class="right-header">
          <div class="timeline-header" id="timelineHeader">
            <div class="months" id="monthsRow"></div>
            <div class="days" id="daysRow"></div>
          </div>
        </div>
        <div class="right-body" id="rightBody">
          <div class="timeline" id="timeline">
            <div class="today-line" id="todayLine"></div>
            <svg class="deps" id="depsSvg"></svg>
            <div id="timelineRows"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <div class="h" id="modalTitle">Task</div>
        <button id="btnModalClose">Close</button>
      </header>
      <div class="body">
        <div class="grid2">
          <div class="field">
            <label for="fName">Name</label>
            <input id="fName" type="text" placeholder="e.g., Design phase" />
          </div>
          <div class="field">
            <label for="fType">Type</label>
            <select id="fType">
              <option value="phase">Phase (summary)</option>
              <option value="activity">Activity (summary)</option>
              <option value="task">Task</option>
              <option value="milestone">Milestone</option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="fStart">Start</label>
            <input id="fStart" type="date" />
          </div>
          <div class="field">
            <label for="fEnd">End</label>
            <input id="fEnd" type="date" />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="fParent">Parent (for sub-levels)</label>
            <select id="fParent"></select>
          </div>
          <div class="field">
            <label for="fDeps">Dependencies (predecessors)</label>
            <select id="fDeps" multiple></select>
          </div>
        </div>

        <div class="rowline">
          <label class="pill" style="cursor:pointer;">
            <input id="fRollup" type="checkbox" style="accent-color: var(--accent);">
            Roll-up dates from children (summary tasks)
          </label>
          <label class="pill" style="cursor:pointer;">
            <input id="fLock" type="checkbox" style="accent-color: var(--accent);">
            Lock (disable bar dragging)
          </label>
        </div>

        <div class=â€helpâ€>
          Workshop Tips:
          <ul>
            <li>Use this planner in client workshops to collaboratively build and sequence project plans.</li>
            <li>Load a scenario template as a starting point, then customise phases, activities and tasks.</li>
            <li>Summary tasks (Phase/Activity) can auto-calculate their date range from child items.</li>
            <li>Double-click any task name (in the left panel or on timeline bars) to edit directly.</li>
            <li>Dependencies show visual links between tasks (no auto-scheduling enforcement).</li>
            <li>Save frequently â€” Ctrl/Cmd+S saves to browser storage.</li>
          </ul>
        </div>
      </div>
      <footer>
        <div class="help" id="modalHint"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="danger" id="btnModalDelete" style="display:none;">Delete</button>
          <button class="primary" id="btnModalSave">Save</button>
        </div>
      </footer>
    </div>
  </div>

  <script>
    'use strict';

    // ======= Date helpers (UTC midnight to avoid DST surprises) =======
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    function parseIso(iso){
      if(!iso) return null;
      const [y,m,d] = iso.split('-').map(Number);
      if(!y || !m || !d) return null;
      return new Date(Date.UTC(y, m-1, d));
    }
    function fmtIso(dt){
      return dt.toISOString().slice(0,10);
    }
    function addDays(iso, days){
      const d = parseIso(iso);
      d.setUTCDate(d.getUTCDate() + days);
      return fmtIso(d);
    }
    function diffDays(isoA, isoB){
      // isoA - isoB in days
      return Math.round((parseIso(isoA) - parseIso(isoB)) / MS_PER_DAY);
    }
    function clampIso(iso, minIso, maxIso){
      const t = parseIso(iso).getTime();
      const minT = parseIso(minIso).getTime();
      const maxT = parseIso(maxIso).getTime();
      return fmtIso(new Date(Math.max(minT, Math.min(maxT, t))));
    }
    function todayIso(){
      const now = new Date();
      const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      return fmtIso(d);
    }
    function monthKey(iso){
      return iso.slice(0,7); // YYYY-MM
    }
    function monthLabel(iso){
      const d = parseIso(iso);
      return d.toLocaleString(undefined, {month:'short', year:'numeric', timeZone:'UTC'});
    }
    function dayLabel(iso){
      const d = parseIso(iso);
      return d.toLocaleString(undefined, {day:'2-digit', timeZone:'UTC'});
    }

    // ======= State =======
    const STORAGE_KEY = 'pwc_project_planner_v1';

    const state = {
      tasks: [],
      selectedId: null,
      chartStart: null,
      chartEnd: null,
      visible: [],  // visible task ids in render order
      config: {
        dayWidth: 24,
        rowHeight: 36,
        headerHeight: 56,
        leftWidth: 580,
        paddingDays: 7
      }
    };

    // ======= DOM =======
    const leftBody = document.getElementById('leftBody');
    const rightBody = document.getElementById('rightBody');
    const timeline = document.getElementById('timeline');
    const timelineRows = document.getElementById('timelineRows');
    const monthsRow = document.getElementById('monthsRow');
    const daysRow = document.getElementById('daysRow');
    const depsSvg = document.getElementById('depsSvg');

    const zoom = document.getElementById('zoom');
    const zoomVal = document.getElementById('zoomVal');
    const leftWidth = document.getElementById('leftWidth');
    const leftWidthVal = document.getElementById('leftWidthVal');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalHint = document.getElementById('modalHint');
    const btnModalClose = document.getElementById('btnModalClose');
    const btnModalSave = document.getElementById('btnModalSave');
    const btnModalDelete = document.getElementById('btnModalDelete');

    const fName = document.getElementById('fName');
    const fType = document.getElementById('fType');
    const fStart = document.getElementById('fStart');
    const fEnd = document.getElementById('fEnd');
    const fParent = document.getElementById('fParent');
    const fDeps = document.getElementById('fDeps');
    const fRollup = document.getElementById('fRollup');
    const fLock = document.getElementById('fLock');

    const fileImport = document.getElementById('fileImport');

    let modalMode = { mode: 'add', id: null, defaultParent: null };

    // ======= Utilities =======
    function uid(){
      // compact-ish unique id
      return 'T' + Math.random().toString(16).slice(2,8) + Date.now().toString(16).slice(-4);
    }

    function deepCopy(x){
      return JSON.parse(JSON.stringify(x));
    }

    function getTask(id){
      return state.tasks.find(t => t.id === id) || null;
    }

    function isSummaryType(type){
      return type === 'phase' || type === 'activity';
    }
    function isMilestone(type){
      return type === 'milestone';
    }

    function childrenOf(id){
      return state.tasks.filter(t => (t.parentId || null) === id);
    }

    function descendantsOf(id){
      const out = new Set();
      function walk(x){
        for(const c of childrenOf(x)){
          if(out.has(c.id)) continue;
          out.add(c.id);
          walk(c.id);
        }
      }
      walk(id);
      return out;
    }

    function buildVisibleOrder(){
      // display in the order tasks appear in state.tasks, while nesting under parents
      const byId = new Map(state.tasks.map(t => [t.id, t]));
      const children = new Map();
      for(const t of state.tasks){
        const p = t.parentId || null;
        if(!children.has(p)) children.set(p, []);
        children.get(p).push(t.id);
      }
      // sort children lists according to tasks array order
      const index = new Map(state.tasks.map((t,i) => [t.id, i]));
      for(const [p, arr] of children.entries()){
        arr.sort((a,b) => (index.get(a) ?? 0) - (index.get(b) ?? 0));
      }

      const levels = new Map();
      function levelOf(id){
        if(levels.has(id)) return levels.get(id);
        const t = byId.get(id);
        if(!t) return 0;
        const p = t.parentId || null;
        const lv = p ? (levelOf(p) + 1) : 0;
        levels.set(id, lv);
        return lv;
      }

      const visible = [];
      function walk(parentId){
        const arr = children.get(parentId || null) || [];
        for(const id of arr){
          visible.push(id);
          const t = byId.get(id);
          if(t && !t.collapsed){
            walk(id);
          }
        }
      }
      walk(null);

      return { visible, levelOf, children };
    }

    function computeChartRange(){
      // use "effective" dates for rollups
      const effective = state.tasks.map(t => effectiveDates(t));
      const starts = effective.map(x => x.start).filter(Boolean);
      const ends = effective.map(x => x.end).filter(Boolean);
      if(starts.length === 0){
        const d = todayIso();
        state.chartStart = addDays(d, -state.config.paddingDays);
        state.chartEnd = addDays(d, +state.config.paddingDays);
        return;
      }
      let minStart = starts.reduce((a,b) => (a < b ? a : b));
      let maxEnd = ends.reduce((a,b) => (a > b ? a : b));

      state.chartStart = addDays(minStart, -state.config.paddingDays);
      state.chartEnd = addDays(maxEnd, +state.config.paddingDays);
    }

    function effectiveDates(task){
      // For summary tasks with rollup=true, compute start/end from children if possible.
      if(isSummaryType(task.type) && task.rollup){
        const kids = childrenOf(task.id);
        if(kids.length){
          let minS = null, maxE = null;
          for(const k of kids){
            const ed = effectiveDates(k);
            if(ed.start){
              if(minS === null || ed.start < minS) minS = ed.start;
            }
            if(ed.end){
              if(maxE === null || ed.end > maxE) maxE = ed.end;
            }
          }
          if(minS && maxE){
            return { start: minS, end: maxE };
          }
        }
      }
      // milestones force end=start
      if(isMilestone(task.type)){
        return { start: task.start, end: task.start };
      }
      return { start: task.start, end: task.end };
    }

    function durationDays(task){
      const ed = effectiveDates(task);
      const d = diffDays(ed.end, ed.start) + 1;
      return Math.max(1, d);
    }

    function taskBadge(task){
      if(isMilestone(task.type)) return ['Milestone', 'milestone'];
      if(isSummaryType(task.type)) return [task.type === 'phase' ? 'Phase' : 'Activity', 'summary'];
      return ['Task', ''];
    }

    function validateTaskDates(t){
      if(!t.start) t.start = todayIso();
      if(!t.end) t.end = t.start;
      if(parseIso(t.end) < parseIso(t.start)) t.end = t.start;
      if(isMilestone(t.type)) t.end = t.start;
    }

    function normalize(){
      // ensure required fields and remove invalid deps
      const ids = new Set(state.tasks.map(t => t.id));
      for(const t of state.tasks){
        if(!t.id) t.id = uid();
        if(!t.name) t.name = 'Untitled';
        if(!t.type) t.type = 'task';
        if(t.parentId && !ids.has(t.parentId)) t.parentId = null;
        if(!Array.isArray(t.dependencies)) t.dependencies = [];
        t.dependencies = t.dependencies.filter(d => ids.has(d) && d !== t.id);
        if(typeof t.rollup !== 'boolean') t.rollup = isSummaryType(t.type);
        if(typeof t.locked !== 'boolean') t.locked = false;
        if(typeof t.collapsed !== 'boolean') t.collapsed = false;
        validateTaskDates(t);
      }
      // break parent cycles (simple guard)
      for(const t of state.tasks){
        if(t.parentId){
          const seen = new Set([t.id]);
          let p = t.parentId;
          while(p){
            if(seen.has(p)){
              t.parentId = null;
              break;
            }
            seen.add(p);
            const pt = getTask(p);
            p = pt ? (pt.parentId || null) : null;
          }
        }
      }
    }

    // ======= Rendering =======
    function applyCssVars(){
      document.documentElement.style.setProperty('--day-width', state.config.dayWidth + 'px');
      document.documentElement.style.setProperty('--row-height', state.config.rowHeight + 'px');
      document.documentElement.style.setProperty('--left-width', state.config.leftWidth + 'px');
    }

    function render(){
      normalize();
      applyCssVars();

      const { visible, levelOf, children } = buildVisibleOrder();
      state.visible = visible;

      computeChartRange();

      const totalDays = diffDays(state.chartEnd, state.chartStart) + 1;
      const timelineWidth = totalDays * state.config.dayWidth;
      const timelineHeight = visible.length * state.config.rowHeight;

      timeline.style.setProperty('--timeline-width', timelineWidth + 'px');
      timeline.style.setProperty('--timeline-height', timelineHeight + 'px');

      // Header
      renderHeader(totalDays);

      // Left body
      leftBody.innerHTML = '';
      for(const id of visible){
        const t = getTask(id);
        if(!t) continue;
        const lvl = levelOf(id);
        const hasKids = (children.get(id) || []).length > 0;
        leftBody.appendChild(renderLeftRow(t, lvl, hasKids));
      }

      // Right rows (timeline)
      timelineRows.innerHTML = '';
      for(let idx=0; idx<visible.length; idx++){
        const id = visible[idx];
        const t = getTask(id);
        if(!t) continue;
        timelineRows.appendChild(renderTimelineRow(t, idx));
      }

      // Today line
      const todayLine = document.getElementById('todayLine');
      const today = todayIso();
      if(today >= state.chartStart && today <= state.chartEnd){
        const todayX = diffDays(today, state.chartStart) * state.config.dayWidth;
        todayLine.style.left = todayX + 'px';
        todayLine.style.display = '';
      } else {
        todayLine.style.display = 'none';
      }

      // Dependencies overlay SVG
      depsSvg.setAttribute('width', timelineWidth);
      depsSvg.setAttribute('height', timelineHeight);
      depsSvg.setAttribute('viewBox', `0 0 ${timelineWidth} ${timelineHeight}`);
      renderDependencies();

      // Sync selection highlight
      highlightSelection();
    }

    function renderHeader(totalDays){
      // build day array
      const days = [];
      for(let i=0;i<totalDays;i++){
        days.push(addDays(state.chartStart, i));
      }

      // months row with spans
      monthsRow.innerHTML = '';
      let i = 0;
      while(i < days.length){
        const mk = monthKey(days[i]);
        let j = i;
        while(j < days.length && monthKey(days[j]) === mk) j++;
        const spanDays = j - i;
        const cell = document.createElement('div');
        cell.className = 'month-cell';
        cell.style.width = (spanDays * state.config.dayWidth) + 'px';
        cell.textContent = monthLabel(days[i]);
        monthsRow.appendChild(cell);
        i = j;
      }

      // days row (label each day; for long ranges you can optimize to label weekly)
      daysRow.innerHTML = '';
      for(let k=0;k<days.length;k++){
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.style.width = state.config.dayWidth + 'px';
        cell.title = days[k];
        cell.textContent = dayLabel(days[k]);
        daysRow.appendChild(cell);
      }

      // horizontal scroll sync: rightBody scrollLeft -> header translate
      syncHeaderScroll();
    }

    function renderLeftRow(task, level, hasKids){
      const row = document.createElement('div');
      row.className = 'task-row';
      row.dataset.taskId = task.id;

      row.addEventListener('click', (e) => {
        // avoid when clicking on inputs/buttons
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if(['button','input','select','option'].includes(tag)) return;
        state.selectedId = task.id;
        highlightSelection();
      });

      const twisty = document.createElement('div');
      twisty.className = 'twisty' + (hasKids ? '' : ' hidden');
      twisty.textContent = task.collapsed ? 'â–¸' : 'â–¾';
      twisty.title = hasKids ? (task.collapsed ? 'Expand' : 'Collapse') : '';
      twisty.addEventListener('click', (e) => {
        e.stopPropagation();
        if(!hasKids) return;
        task.collapsed = !task.collapsed;
        render();
      });

      const name = document.createElement('div');
      name.className = 'name';
      name.style.paddingLeft = (level * 16) + 'px';

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = task.name;
      label.style.cursor = 'text';
      label.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        const input = document.createElement('input');
        input.type = 'text';
        input.value = task.name;
        input.style.cssText = 'width:100%;padding:2px 4px;font:inherit;border:1px solid var(--accent);border-radius:4px;outline:none;background:#fff;color:#1a1a1a;';
        label.replaceWith(input);
        input.focus();
        input.select();
        const save = () => {
          const val = input.value.trim();
          if(val) task.name = val;
          render();
        };
        input.addEventListener('blur', save);
        input.addEventListener('keydown', (ev) => {
          if(ev.key === 'Enter'){ ev.preventDefault(); save(); }
          if(ev.key === 'Escape') render();
          ev.stopPropagation();
        });
        input.addEventListener('pointerdown', (ev) => ev.stopPropagation());
      });

      const [badgeText, badgeClass] = taskBadge(task);
      const badge = document.createElement('span');
      badge.className = 'badge' + (badgeClass ? ' ' + badgeClass : '');
      badge.textContent = badgeText;

      name.appendChild(label);
      name.appendChild(badge);

      const dates = document.createElement('div');
      dates.className = 'dates';

      const ed = effectiveDates(task);

      const startInput = document.createElement('input');
      startInput.type = 'date';
      startInput.value = ed.start;
      startInput.disabled = isSummaryType(task.type) && task.rollup;
      startInput.addEventListener('change', () => {
        task.start = startInput.value;
        if(isMilestone(task.type)) task.end = task.start;
        if(parseIso(task.end) < parseIso(task.start)) task.end = task.start;
        render();
      });

      const endInput = document.createElement('input');
      endInput.type = 'date';
      endInput.value = ed.end;
      endInput.disabled = isMilestone(task.type) || (isSummaryType(task.type) && task.rollup);
      endInput.addEventListener('change', () => {
        task.end = endInput.value;
        if(parseIso(task.end) < parseIso(task.start)) task.start = task.end;
        render();
      });

      dates.appendChild(startInput);
      dates.appendChild(endInput);

      const actions = document.createElement('div');
      actions.className = 'row-actions';

      const btnEdit = iconBtn('âœŽ', 'Edit');
      btnEdit.addEventListener('click', (e) => {
        e.stopPropagation();
        openModalEdit(task.id);
      });

      const btnChild = iconBtn('+', 'Add child');
      btnChild.addEventListener('click', (e) => {
        e.stopPropagation();
        openModalAdd(task.id);
      });

      const btnUp = iconBtn('â†‘', 'Move up');
      btnUp.addEventListener('click', (e) => {
        e.stopPropagation();
        moveTask(task.id, -1);
      });

      const btnDown = iconBtn('â†“', 'Move down');
      btnDown.addEventListener('click', (e) => {
        e.stopPropagation();
        moveTask(task.id, +1);
      });

      const btnDel = iconBtn('ðŸ—‘', 'Delete');
      btnDel.classList.add('danger');
      btnDel.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteTask(task.id);
      });

      actions.appendChild(btnEdit);
      actions.appendChild(btnChild);
      actions.appendChild(btnUp);
      actions.appendChild(btnDown);
      actions.appendChild(btnDel);

      row.appendChild(twisty);
      row.appendChild(name);
      row.appendChild(dates);
      row.appendChild(actions);
      return row;
    }

    function iconBtn(text, title){
      const b = document.createElement('button');
      b.className = 'icon-btn';
      b.type = 'button';
      b.textContent = text;
      b.title = title;
      return b;
    }

    function xStartPx(task){
      const ed = effectiveDates(task);
      return diffDays(ed.start, state.chartStart) * state.config.dayWidth;
    }
    function xEndPx(task){
      const ed = effectiveDates(task);
      const daysFromStart = diffDays(ed.end, state.chartStart);
      return (daysFromStart + 1) * state.config.dayWidth;
    }

    function renderTimelineRow(task, rowIndex){
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.taskId = task.id;

      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.dataset.taskId = task.id;

      const isSummary = isSummaryType(task.type);
      const isMs = isMilestone(task.type);

      if(isSummary) bar.classList.add('summary');
      if(isMs) bar.classList.add('milestone');

      // Position
      const left = xStartPx(task);
      if(isMs){
        bar.style.left = (left + Math.floor(state.config.dayWidth / 2)) + 'px';
      } else {
        const width = xEndPx(task) - left;
        bar.style.left = left + 'px';
        bar.style.width = Math.max(6, width) + 'px';

        const barLabel = document.createElement('span');
        barLabel.className = 'bar-label';
        barLabel.textContent = task.name;
        barLabel.style.cssText = 'pointer-events:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;';
        bar.appendChild(barLabel);
      }

      // Handles (not for milestones or locked/summary rollup)
      const draggable = !(isSummary && task.rollup) && !task.locked;
      if(!isMs && draggable){
        const hl = document.createElement('div');
        hl.className = 'handle left';
        const hr = document.createElement('div');
        hr.className = 'handle right';
        bar.appendChild(hl);
        bar.appendChild(hr);
      }
      if(draggable){
        bar.addEventListener('pointerdown', onBarPointerDown);
      }

      // Double-click to inline-edit bar text
      if(!isMs){
        bar.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          e.preventDefault();
          if(bar.querySelector('.bar-edit-input')) return;
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'bar-edit-input';
          input.value = task.name;
          input.style.cssText = 'background:rgba(255,255,255,0.95);color:#000;border:1px solid var(--accent);border-radius:4px;padding:0 4px;font-size:12px;width:100%;height:100%;position:absolute;top:0;left:0;z-index:5;outline:none;';
          bar.style.position = 'absolute';
          bar.appendChild(input);
          input.focus();
          input.select();
          const save = () => {
            const val = input.value.trim();
            if(val) task.name = val;
            render();
          };
          input.addEventListener('blur', save);
          input.addEventListener('keydown', (ev) => {
            if(ev.key === 'Enter'){ ev.preventDefault(); save(); }
            if(ev.key === 'Escape') render();
            ev.stopPropagation();
          });
          input.addEventListener('pointerdown', (ev) => ev.stopPropagation());
        });
      }

      row.appendChild(bar);
      return row;
    }

    function highlightSelection(){
      // left
      for(const el of leftBody.querySelectorAll('.task-row')){
        el.classList.toggle('selected', el.dataset.taskId === state.selectedId);
      }
    }

    // ======= Scroll syncing =======
    let syncing = false;

    leftBody.addEventListener('scroll', () => {
      if(syncing) return;
      syncing = true;
      rightBody.scrollTop = leftBody.scrollTop;
      syncing = false;
    });
    rightBody.addEventListener('scroll', () => {
      if(syncing) return;
      syncing = true;
      leftBody.scrollTop = rightBody.scrollTop;
      syncing = false;
      syncHeaderScroll();
    });

    function syncHeaderScroll(){
      // translate header to match horizontal scroll
      const x = rightBody.scrollLeft;
      document.getElementById('timelineHeader').style.transform = `translateX(${-x}px)`;
    }

    // ======= Drag/resize =======
    let drag = null;
    let rafDeps = false;

    function onBarPointerDown(e){
      const id = e.currentTarget.dataset.taskId;
      const t = getTask(id);
      if(!t) return;

      const isSummary = isSummaryType(t.type) && t.rollup;
      if(isSummary || t.locked) return;

      const target = e.target;
      let mode = 'move';
      if(target.classList && target.classList.contains('handle')){
        mode = target.classList.contains('left') ? 'resize-left' : 'resize-right';
      }
      if(isMilestone(t.type)) mode = 'move';

      e.currentTarget.setPointerCapture(e.pointerId);

      drag = {
        id,
        pointerId: e.pointerId,
        mode,
        startX: e.clientX,
        origStart: t.start,
        origEnd: t.end,
        hasMoved: false
      };

      // visual cue
      e.currentTarget.style.cursor = (mode === 'move') ? 'grabbing' : 'ew-resize';

      e.preventDefault();
      e.stopPropagation();
    }

    window.addEventListener('pointermove', (e) => {
      if(!drag) return;
      if(e.pointerId !== drag.pointerId) return;

      const t = getTask(drag.id);
      if(!t) return;

      const dx = e.clientX - drag.startX;
      const dd = Math.round(dx / state.config.dayWidth);
      if(dd !== 0) drag.hasMoved = true;

      let newStart = drag.origStart;
      let newEnd = drag.origEnd;

      if(isMilestone(t.type)){
        newStart = addDays(drag.origStart, dd);
        newEnd = newStart;
      } else if(drag.mode === 'move'){
        newStart = addDays(drag.origStart, dd);
        newEnd = addDays(drag.origEnd, dd);
      } else if(drag.mode === 'resize-left'){
        newStart = addDays(drag.origStart, dd);
        if(parseIso(newStart) > parseIso(newEnd)) newStart = newEnd;
      } else if(drag.mode === 'resize-right'){
        newEnd = addDays(drag.origEnd, dd);
        if(parseIso(newEnd) < parseIso(newStart)) newEnd = newStart;
      }

      // update task in state (live)
      t.start = newStart;
      t.end = newEnd;
      validateTaskDates(t);

      // update DOM bar only for this task
      updateBarDom(t);

      scheduleDepsRender();
    });

    window.addEventListener('pointerup', (e) => {
      if(!drag) return;
      if(e.pointerId !== drag.pointerId) return;

      const moved = drag.hasMoved;
      drag = null;

      // only re-render if actually dragged (allows dblclick to fire on bars)
      if(moved) render();
    });

    function updateBarDom(task){
      // left date inputs
      const leftRow = leftBody.querySelector(`.task-row[data-task-id="${cssEscape(task.id)}"]`);
      if(leftRow){
        const inputs = leftRow.querySelectorAll('input[type="date"]');
        const ed = effectiveDates(task);
        if(inputs[0]) inputs[0].value = ed.start;
        if(inputs[1]) inputs[1].value = ed.end;
      }

      // bar
      const bar = timelineRows.querySelector(`.bar[data-task-id="${cssEscape(task.id)}"]`);
      if(!bar) return;

      const isMs = isMilestone(task.type);
      const left = xStartPx(task);
      if(isMs){
        bar.style.left = (left + Math.floor(state.config.dayWidth / 2)) + 'px';
      } else {
        const width = xEndPx(task) - left;
        bar.style.left = left + 'px';
        bar.style.width = Math.max(6, width) + 'px';
      }
    }

    function scheduleDepsRender(){
      if(rafDeps) return;
      rafDeps = true;
      requestAnimationFrame(() => {
        rafDeps = false;
        renderDependencies();
      });
    }

    // ======= Dependencies overlay =======
    function renderDependencies(){
      // build coordinates in timeline space
      const coords = new Map();
      for(let i=0; i<state.visible.length; i++){
        const id = state.visible[i];
        const t = getTask(id);
        if(!t) continue;
        const ed = effectiveDates(t);
        const y = i * state.config.rowHeight + state.config.rowHeight / 2;
        if(isMilestone(t.type)){
          const x = diffDays(ed.start, state.chartStart) * state.config.dayWidth + state.config.dayWidth / 2;
          coords.set(id, {xStart:x, xEnd:x, y});
        } else {
          const xs = diffDays(ed.start, state.chartStart) * state.config.dayWidth;
          const xe = (diffDays(ed.end, state.chartStart) + 1) * state.config.dayWidth;
          coords.set(id, {xStart: xs, xEnd: xe, y});
        }
      }

      // clear
      depsSvg.innerHTML = '';
      // marker
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
      marker.setAttribute('id','arrow');
      marker.setAttribute('markerWidth','8');
      marker.setAttribute('markerHeight','8');
      marker.setAttribute('refX','7');
      marker.setAttribute('refY','4');
      marker.setAttribute('orient','auto');
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points','0,0 8,4 0,8');
      poly.setAttribute('fill','rgba(0,0,0,0.35)');
      marker.appendChild(poly);
      defs.appendChild(marker);
      depsSvg.appendChild(defs);

      // Finish-to-start dependency routing
      const GAP = 12;
      const ARROW = 8;
      const rowH = state.config.rowHeight;

      for(const succId of state.visible){
        const succ = getTask(succId);
        if(!succ || !succ.dependencies) continue;
        const sc = coords.get(succId);
        if(!sc) continue;

        for(const predId of succ.dependencies){
          const pc = coords.get(predId);
          if(!pc) continue;

          const sx = pc.xEnd;   // right edge of predecessor bar
          const sy = pc.y;      // vertical center of predecessor row
          const ex = sc.xStart; // left edge of successor bar
          const ey = sc.y;      // vertical center of successor row
          const targetX = ex - ARROW; // leave space for arrowhead

          let pathD;

          if(targetX > sx + GAP * 2){
            // Simple case: enough horizontal space between bars
            // L-route: right to midpoint, vertical to succ row, horizontal to target
            const midX = sx + (ex - sx) / 2;
            pathD = `M ${sx} ${sy} H ${midX} V ${ey} H ${targetX}`;
          } else {
            // Overlap case: predecessor ends near/after successor starts
            // S-route: right, vertical to midpoint between rows, left, vertical to succ, right to target
            const rightX = sx + GAP;
            const leftX = ex - GAP;
            let midY;
            if(Math.abs(ey - sy) < 1){
              // Same row: route below
              midY = sy + rowH * 0.7;
            } else {
              // Route through midpoint between the two rows
              midY = (sy + ey) / 2;
            }
            pathD = `M ${sx} ${sy} H ${rightX} V ${midY} H ${leftX} V ${ey} H ${targetX}`;
          }

          const p = document.createElementNS('http://www.w3.org/2000/svg','path');
          p.setAttribute('d', pathD);
          p.setAttribute('marker-end','url(#arrow)');
          depsSvg.appendChild(p);
        }
      }
    }

    // ======= Modal logic =======
    function openModalAdd(parentId=null){
      modalMode = { mode:'add', id:null, defaultParent: parentId };
      modalTitle.textContent = 'Add item';
      modalHint.textContent = parentId ? `Parent: ${getTask(parentId)?.name ?? parentId}` : 'Root level';
      btnModalDelete.style.display = 'none';

      // defaults
      fName.value = '';
      fType.value = parentId ? 'task' : 'phase';
      const d = todayIso();
      fStart.value = d;
      fEnd.value = addDays(d, 6);
      fRollup.checked = (fType.value === 'phase' || fType.value === 'activity');
      fLock.checked = false;

      populateParentOptions(null, parentId);
      populateDependencyOptions(null);

      syncModalFieldsForType();
      openModal();
    }

    function openModalEdit(id){
      const t = getTask(id);
      if(!t) return;

      modalMode = { mode:'edit', id, defaultParent: null };
      modalTitle.textContent = 'Edit item';
      modalHint.textContent = `ID: ${id}`;
      btnModalDelete.style.display = 'inline-flex';

      fName.value = t.name;
      fType.value = t.type;
      fStart.value = t.start;
      fEnd.value = isMilestone(t.type) ? t.start : t.end;
      fRollup.checked = !!t.rollup;
      fLock.checked = !!t.locked;

      populateParentOptions(id, t.parentId || null);
      populateDependencyOptions(id);

      // set deps selections
      const depSet = new Set(t.dependencies || []);
      for(const opt of Array.from(fDeps.options)){
        opt.selected = depSet.has(opt.value);
      }

      syncModalFieldsForType();
      openModal();
    }

    function openModal(){
      modalBackdrop.classList.add('open');
      // focus
      setTimeout(() => fName.focus(), 0);
    }
    function closeModal(){
      modalBackdrop.classList.remove('open');
    }

    btnModalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if(e.target === modalBackdrop) closeModal();
    });

    fType.addEventListener('change', () => {
      // default rollup for summary types
      if(isSummaryType(fType.value)) fRollup.checked = true;
      if(isMilestone(fType.value)) fEnd.value = fStart.value;
      syncModalFieldsForType();
    });
    fStart.addEventListener('change', () => {
      if(isMilestone(fType.value)) fEnd.value = fStart.value;
      if(parseIso(fEnd.value) < parseIso(fStart.value)) fEnd.value = fStart.value;
    });
    fEnd.addEventListener('change', () => {
      if(parseIso(fEnd.value) < parseIso(fStart.value)) fStart.value = fEnd.value;
    });

    function syncModalFieldsForType(){
      const type = fType.value;
      const summary = isSummaryType(type);
      const ms = isMilestone(type);

      fRollup.disabled = !summary;
      fRollup.parentElement.style.opacity = summary ? '1' : '0.5';

      fEnd.disabled = ms;
      if(ms) fEnd.value = fStart.value;

      // if summary + rollup, still allow users to set base dates (kept, but rollup used for display)
      // no change here.
    }

    function populateParentOptions(editId, selectedParentId){
      const currentId = editId;
      const disallowed = currentId ? descendantsOf(currentId) : new Set();

      fParent.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '(none)';
      fParent.appendChild(opt0);

      for(const t of state.tasks){
        if(currentId && t.id === currentId) continue;
        if(disallowed.has(t.id)) continue;
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name} [${t.id}]`;
        fParent.appendChild(opt);
      }

      fParent.value = selectedParentId || '';
    }

    function populateDependencyOptions(editId){
      const currentId = editId;
      const disallowed = currentId ? descendantsOf(currentId) : new Set();
      fDeps.innerHTML = '';

      for(const t of state.tasks){
        if(currentId && t.id === currentId) continue;
        if(disallowed.has(t.id)) continue;
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name} [${t.id}]`;
        fDeps.appendChild(opt);
      }
    }

    btnModalSave.addEventListener('click', () => {
      const name = (fName.value || '').trim() || 'Untitled';
      const type = fType.value;
      const start = fStart.value || todayIso();
      const end = isMilestone(type) ? start : (fEnd.value || start);
      const parentId = fParent.value || null;
      const deps = Array.from(fDeps.selectedOptions).map(o => o.value);

      const rollup = isSummaryType(type) ? !!fRollup.checked : false;
      const locked = !!fLock.checked;

      if(modalMode.mode === 'add'){
        const id = uid();
        const t = {
          id,
          name,
          type,
          start,
          end,
          parentId,
          dependencies: deps,
          rollup,
          locked,
          collapsed: false
        };
        validateTaskDates(t);
        state.tasks.push(t);
        state.selectedId = id;
      } else if(modalMode.mode === 'edit'){
        const t = getTask(modalMode.id);
        if(!t) return;
        t.name = name;
        t.type = type;
        t.start = start;
        t.end = end;
        t.parentId = parentId;
        t.dependencies = deps;
        t.rollup = rollup;
        t.locked = locked;
        validateTaskDates(t);
        state.selectedId = t.id;
      }

      closeModal();
      render();
    });

    btnModalDelete.addEventListener('click', () => {
      if(modalMode.mode !== 'edit') return;
      const id = modalMode.id;
      deleteTask(id);
      closeModal();
    });

    // ======= CRUD operations =======
    function deleteTask(id){
      // remove task + descendants
      const toDelete = descendantsOf(id);
      toDelete.add(id);

      state.tasks = state.tasks.filter(t => !toDelete.has(t.id));

      // clean deps
      const remaining = new Set(state.tasks.map(t => t.id));
      for(const t of state.tasks){
        t.dependencies = (t.dependencies || []).filter(d => remaining.has(d));
        if(t.parentId && !remaining.has(t.parentId)) t.parentId = null;
      }

      if(state.selectedId && toDelete.has(state.selectedId)) state.selectedId = null;

      render();
    }

    function moveTask(id, dir){
      // Move within tasks array by swapping with nearest sibling in the same parent
      const t = getTask(id);
      if(!t) return;

      const siblings = state.tasks.filter(x => (x.parentId || null) === (t.parentId || null));
      const idxInSibs = siblings.findIndex(x => x.id === id);
      if(idxInSibs === -1) return;
      const targetIdx = idxInSibs + dir;
      if(targetIdx < 0 || targetIdx >= siblings.length) return;
      const otherId = siblings[targetIdx].id;

      const idxA = state.tasks.findIndex(x => x.id === id);
      const idxB = state.tasks.findIndex(x => x.id === otherId);
      if(idxA === -1 || idxB === -1) return;

      const tmp = state.tasks[idxA];
      state.tasks[idxA] = state.tasks[idxB];
      state.tasks[idxB] = tmp;

      render();
    }

    // ======= Export / Import / Save =======
    function downloadBlob(filename, blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function exportJson(){
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        config: state.config,
        tasks: deepCopy(state.tasks)
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      downloadBlob('pwc-project-plan.json', blob);
    }

    function importJsonFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(!obj || !Array.isArray(obj.tasks)) throw new Error('Invalid JSON: expected {tasks:[...]}');
          state.tasks = obj.tasks;
          // config optional
          if(obj.config && typeof obj.config === 'object'){
            state.config = {...state.config, ...obj.config};
          }
          // sync sliders
          zoom.value = String(state.config.dayWidth);
          zoomVal.textContent = zoom.value;
          leftWidth.value = String(state.config.leftWidth);
          leftWidthVal.textContent = leftWidth.value;

          render();
        }catch(err){
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function saveLocal(){
      const payload = {
        version: 1,
        savedAt: new Date().toISOString(),
        config: state.config,
        tasks: deepCopy(state.tasks)
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      alert('Saved to browser storage.');
    }

    function loadLocal(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        alert('Nothing saved yet.');
        return;
      }
      try{
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.tasks)) throw new Error('Invalid saved payload');
        state.tasks = obj.tasks;
        if(obj.config && typeof obj.config === 'object'){
          state.config = {...state.config, ...obj.config};
        }
        zoom.value = String(state.config.dayWidth);
        zoomVal.textContent = zoom.value;
        leftWidth.value = String(state.config.leftWidth);
        leftWidthVal.textContent = leftWidth.value;

        render();
      }catch(err){
        alert('Load failed: ' + err.message);
      }
    }

    function clearAll(){
      if(!confirm('Clear all tasks?')) return;
      state.tasks = [];
      state.selectedId = null;
      render();
    }

    function exportExcelXls(){
      // Excel-compatible HTML table saved as .xls
      const cols = ['ID','Name','Type','Parent ID','Start','End','Dependencies'];
      const esc = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

      let html = '';
      html += '<html><head><meta charset="UTF-8"></head><body>';
      html += '<table border="1" cellpadding="4" cellspacing="0">';
      html += '<tr>' + cols.map(c => `<th>${esc(c)}</th>`).join('') + '</tr>';
      for(const t of state.tasks){
        const deps = (t.dependencies || []).join(',');
        html += '<tr>' + [
          t.id,
          t.name,
          t.type,
          t.parentId || '',
          t.start,
          isMilestone(t.type) ? t.start : t.end,
          deps
        ].map(v => `<td>${esc(v)}</td>`).join('') + '</tr>';
      }
      html += '</table></body></html>';

      const blob = new Blob([html], {type:'application/vnd.ms-excel'});
      downloadBlob('pwc-project-plan.xls', blob);
    }

    // ======= Export SVG / PNG =======
    function buildExportSvgString(){
      // Build a self-contained SVG of the full (visible) chart including left labels and timeline.
      // This avoids html2canvas and works offline.
      const leftW = state.config.leftWidth;
      const rowH = state.config.rowHeight;
      const headerH = 64; // for export (a bit bigger than UI)
      const dayW = state.config.dayWidth;

      const totalDays = diffDays(state.chartEnd, state.chartStart) + 1;
      const width = leftW + totalDays * dayW;
      const height = headerH + state.visible.length * rowH;

      // Build visible order and levels again for labels
      const { visible, levelOf, children } = buildVisibleOrder();

      // Precompute coords
      const coords = new Map();
      for(let i=0;i<visible.length;i++){
        const id = visible[i];
        const t = getTask(id);
        if(!t) continue;
        const ed = effectiveDates(t);
        const y = headerH + i*rowH;
        if(isMilestone(t.type)){
          const x = leftW + diffDays(ed.start, state.chartStart)*dayW + dayW/2;
          coords.set(id, {xStart:x, xEnd:x, yMid: y + rowH/2, rowY:y});
        }else{
          const xs = leftW + diffDays(ed.start, state.chartStart)*dayW;
          const xe = leftW + (diffDays(ed.end, state.chartStart)+1)*dayW;
          coords.set(id, {xStart:xs, xEnd:xe, yMid: y + rowH/2, rowY:y});
        }
      }

      // Header labels: months
      const days = [];
      for(let i=0;i<totalDays;i++) days.push(addDays(state.chartStart, i));

      // Build month spans
      const monthSpans = [];
      let i = 0;
      while(i < days.length){
        const mk = monthKey(days[i]);
        let j = i;
        while(j < days.length && monthKey(days[j]) === mk) j++;
        monthSpans.push({label: monthLabel(days[i]), start: i, len: j-i});
        i = j;
      }

      // SVG pieces
      const parts = [];
      parts.push(`<?xml version="1.0" encoding="UTF-8"?>`);
      parts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`);
      parts.push(`<defs>
        <style>
          .bg{ fill:#ffffff; }
          .panel{ fill:#f8f8f9; }
          .left{ fill:#f0f1f3; }
          .grid{ stroke: rgba(0,0,0,0.06); stroke-width:1; }
          .grid2{ stroke: rgba(0,0,0,0.12); stroke-width:1; }
          .hline{ stroke: rgba(0,0,0,0.08); stroke-width:1; }
          .text{ fill:#1a1a1a; font-family: ${state.config.fontFamily ?? 'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'}; font-size: 12px; }
          .muted{ fill:#6b7280; font-size: 11px; }
          .month{ fill:#1a1a1a; font-weight: 700; font-size: 12px; }
          .barTask{ fill: ${getComputedStyle(document.documentElement).getPropertyValue('--bar-task').trim() || '#FD5108'}; }
          .barSum{ fill: ${getComputedStyle(document.documentElement).getPropertyValue('--bar-summary').trim() || '#6b7280'}; }
          .barMs{ fill: ${getComputedStyle(document.documentElement).getPropertyValue('--bar-milestone').trim() || '#E84000'}; }
          .barStroke{ stroke: rgba(0,0,0,0.15); stroke-width: 1; }
          .barLabel{ fill: #ffffff; font-size: 12px; }
          .dep{ stroke: rgba(0,0,0,0.35); stroke-width: 1.5; fill: none; }
        </style>
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
          <polygon points="0,0 8,4 0,8" fill="rgba(0,0,0,0.35)"/>
        </marker>
      </defs>`);

      // Background panels
      parts.push(`<rect class="bg" x="0" y="0" width="${width}" height="${height}"/>`);
      parts.push(`<rect class="left" x="0" y="0" width="${leftW}" height="${height}"/>`);
      parts.push(`<rect class="panel" x="${leftW}" y="0" width="${width-leftW}" height="${height}"/>`);
      parts.push(`<rect class="panel" x="0" y="0" width="${width}" height="${headerH}"/>`);

      // Header separators
      parts.push(`<line class="grid2" x1="${leftW}" y1="0" x2="${leftW}" y2="${height}"/>`);
      parts.push(`<line class="grid2" x1="0" y1="${headerH}" x2="${width}" y2="${headerH}"/>`);

      // Vertical grid lines
      for(let d=0; d<=totalDays; d++){
        const x = leftW + d*dayW;
        const cls = (d % 7 === 0) ? 'grid2' : 'grid';
        parts.push(`<line class="${cls}" x1="${x}" y1="${headerH}" x2="${x}" y2="${height}"/>`);
      }

      // Month labels
      const monthY = 18;
      for(const ms of monthSpans){
        const x = leftW + ms.start * dayW;
        const w = ms.len * dayW;
        parts.push(`<text class="month" x="${x + 6}" y="${monthY}">${escapeXml(ms.label)}</text>`);
        // optional month boundary line already included by grid lines
      }

      // Day labels (every day; if too dense, you can change to every 2/7)
      const dayY = 42;
      for(let d=0; d<days.length; d++){
        const x = leftW + d*dayW + dayW/2;
        parts.push(`<text class="muted" text-anchor="middle" x="${x}" y="${dayY}">${escapeXml(dayLabel(days[d]))}</text>`);
      }

      // Row lines + left labels
      for(let r=0; r<visible.length; r++){
        const y = headerH + r*rowH;
        parts.push(`<line class="hline" x1="0" y1="${y}" x2="${width}" y2="${y}"/>`);
        const id = visible[r];
        const t = getTask(id);
        if(!t) continue;
        const lvl = levelOf(id);
        const xText = 10 + lvl*16;
        const yText = y + rowH/2 + 4;
        const badge = isMilestone(t.type) ? 'Milestone' : (isSummaryType(t.type) ? (t.type==='phase'?'Phase':'Activity') : 'Task');
        parts.push(`<text class="text" x="${xText}" y="${yText}">${escapeXml(t.name)}</text>`);
        parts.push(`<text class="muted" x="${Math.max(xText + 180, leftW - 90)}" y="${yText}" text-anchor="end">${escapeXml(badge)}</text>`);
      }
      // final bottom line
      parts.push(`<line class="hline" x1="0" y1="${height}" x2="${width}" y2="${height}"/>`);

      // Dependency paths (visible only) â€” finish-to-start routing
      const GAP = 12;
      const ARROW = 8;
      for(const succId of visible){
        const succ = getTask(succId);
        if(!succ || !succ.dependencies) continue;
        const sc = coords.get(succId);
        if(!sc) continue;
        for(const predId of succ.dependencies){
          const pc = coords.get(predId);
          if(!pc) continue;
          const sx = pc.xEnd;
          const sy = pc.yMid;
          const ex = sc.xStart;
          const ey = sc.yMid;
          const targetX = ex - ARROW;

          let dPath;
          if(targetX > sx + GAP * 2){
            const midX = sx + (ex - sx) / 2;
            dPath = `M ${sx} ${sy} H ${midX} V ${ey} H ${targetX}`;
          } else {
            const rightX = sx + GAP;
            const leftX = ex - GAP;
            let midY;
            if(Math.abs(ey - sy) < 1){
              midY = sy + rowH * 0.7;
            } else {
              midY = (sy + ey) / 2;
            }
            dPath = `M ${sx} ${sy} H ${rightX} V ${midY} H ${leftX} V ${ey} H ${targetX}`;
          }
          parts.push(`<path class="dep" d="${dPath}" marker-end="url(#arrow)"/>`);
        }
      }

      // Bars
      for(const id of visible){
        const t = getTask(id);
        const c = coords.get(id);
        if(!t || !c) continue;

        if(isMilestone(t.type)){
          const size = 10;
          const cx = c.xStart;
          const cy = c.yMid;
          // diamond
          parts.push(`<polygon class="barMs barStroke" points="${cx},${cy-size} ${cx+size},${cy} ${cx},${cy+size} ${cx-size},${cy}"/>`);
        } else {
          const y = c.rowY + 8;
          const h = 20;
          const w = Math.max(6, c.xEnd - c.xStart);
          const cls = isSummaryType(t.type) ? 'barSum' : 'barTask';
          parts.push(`<rect class="${cls} barStroke" x="${c.xStart}" y="${y}" width="${w}" height="${h}" rx="4" ry="4"/>`);
          // label (clip if too narrow)
          if(w >= 48){
            parts.push(`<text class="barLabel" x="${c.xStart + 8}" y="${y + 14}">${escapeXml(t.name)}</text>`);
          }
        }
      }

      // Today line (optional)
      const today = todayIso();
      if(today >= state.chartStart && today <= state.chartEnd){
        const x = leftW + diffDays(today, state.chartStart)*dayW;
        parts.push(`<line x1="${x}" y1="${headerH}" x2="${x}" y2="${height}" stroke="rgba(239,68,68,0.65)" stroke-width="2"/>`);
      }

      parts.push(`</svg>`);
      return parts.join('\\n');
    }

    function escapeXml(s){
      return String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&apos;');
    }

    function exportSvg(){
      const svg = buildExportSvgString();
      const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      downloadBlob('pwc-project-plan.svg', blob);
    }

    function exportPng(){
      const svg = buildExportSvgString();
      const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = () => {
        try{
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          // white background for PNG
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          canvas.toBlob((pngBlob) => {
            if(pngBlob) downloadBlob('pwc-project-plan.png', pngBlob);
            URL.revokeObjectURL(url);
          }, 'image/png');
        }catch(err){
          URL.revokeObjectURL(url);
          alert('PNG export failed: ' + err.message);
        }
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        alert('PNG export failed: could not render SVG in this browser.');
      };
      img.src = url;
    }

    // ======= CSS escape helper =======
    function cssEscape(s){
      // minimal escape for attribute selectors
      return String(s).replace(/"/g, '\\"');
    }

    // ======= Buttons =======
    document.getElementById('btnAdd').addEventListener('click', () => openModalAdd(null));
    document.getElementById('btnSaveLocal').addEventListener('click', saveLocal);
    document.getElementById('btnLoadLocal').addEventListener('click', loadLocal);
    document.getElementById('btnExportJson').addEventListener('click', exportJson);
    document.getElementById('btnExportPng').addEventListener('click', exportPng);
    document.getElementById('btnExportSvg').addEventListener('click', exportSvg);
    document.getElementById('btnExportExcel').addEventListener('click', exportExcelXls);
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnClear').addEventListener('click', clearAll);

    fileImport.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) importJsonFile(file);
      fileImport.value = '';
    });

    zoom.addEventListener('input', () => {
      state.config.dayWidth = Number(zoom.value);
      zoomVal.textContent = zoom.value;
      render();
    });
    leftWidth.addEventListener('input', () => {
      state.config.leftWidth = Number(leftWidth.value);
      leftWidthVal.textContent = leftWidth.value;
      render();
    });

    // ======= Scenario Templates =======
    const SCENARIOS = {
      'tech-transformation': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('TT1','Phase 1 â€” Discovery & Assessment','phase',0,20,null,[],1),
          t('TT1A','Stakeholder Engagement','activity',0,9,'TT1',[],1),
          t('TT1A1','Identify key stakeholders','task',0,2,'TT1A',[]),
          t('TT1A2','Conduct stakeholder interviews','task',3,7,'TT1A',['TT1A1']),
          t('TT1A3','Document requirements & pain points','task',8,9,'TT1A',['TT1A2']),
          t('TT1B','Current State Assessment','activity',5,18,'TT1',[],1),
          t('TT1B1','Technology landscape mapping','task',5,9,'TT1B',[]),
          t('TT1B2','Gap analysis & capability assessment','task',10,15,'TT1B',['TT1B1']),
          t('TT1B3','Findings report','task',16,18,'TT1B',['TT1B2']),
          t('TT1M','Discovery complete','milestone',20,20,'TT1',['TT1A3','TT1B3']),

          t('TT2','Phase 2 â€” Solution Design','phase',21,48,null,['TT1M'],1),
          t('TT2A','Architecture & Design','activity',21,38,'TT2',[],1),
          t('TT2A1','Solution architecture design','task',21,28,'TT2A',[]),
          t('TT2A2','Technical specification','task',29,35,'TT2A',['TT2A1']),
          t('TT2A3','Design review & sign-off','task',36,38,'TT2A',['TT2A2']),
          t('TT2B','Roadmap Planning','activity',35,46,'TT2',[],1),
          t('TT2B1','Implementation roadmap','task',35,40,'TT2B',[]),
          t('TT2B2','Resource & cost planning','task',41,46,'TT2B',['TT2B1']),
          t('TT2M','Design complete','milestone',48,48,'TT2',['TT2A3','TT2B2']),

          t('TT3','Phase 3 â€” Build & Configure','phase',49,104,null,['TT2M'],1),
          t('TT3A','Core Build','activity',49,83,'TT3',[],1),
          t('TT3A1','Environment setup & foundation','task',49,58,'TT3A',[]),
          t('TT3A2','Core feature development','task',59,76,'TT3A',['TT3A1']),
          t('TT3A3','Integration development','task',77,83,'TT3A',['TT3A2']),
          t('TT3B','Configuration & Data','activity',77,102,'TT3',[],1),
          t('TT3B1','System configuration','task',77,90,'TT3B',[]),
          t('TT3B2','Data migration preparation','task',91,102,'TT3B',['TT3B1']),
          t('TT3M','Build complete','milestone',104,104,'TT3',['TT3A3','TT3B2']),

          t('TT4','Phase 4 â€” Testing & QA','phase',105,132,null,['TT3M'],1),
          t('TT4A1','System integration testing','task',105,115,'TT4',[]),
          t('TT4A2','User acceptance testing','task',116,126,'TT4',['TT4A1']),
          t('TT4A3','Performance & security testing','task',120,130,'TT4',[]),
          t('TT4M','Testing sign-off','milestone',132,132,'TT4',['TT4A2','TT4A3']),

          t('TT5','Phase 5 â€” Deployment & Go-Live','phase',133,153,null,['TT4M'],1),
          t('TT5A1','Deployment planning & rehearsal','task',133,140,'TT5',[]),
          t('TT5A2','Go-live execution','task',141,148,'TT5',['TT5A1']),
          t('TT5A3','Post go-live validation','task',149,153,'TT5',['TT5A2']),
          t('TT5M','Go-live complete','milestone',153,153,'TT5',['TT5A3']),

          t('TT6','Phase 6 â€” Hypercare & Transition','phase',154,182,null,['TT5M'],1),
          t('TT6A1','Post go-live support','task',154,168,'TT6',[]),
          t('TT6A2','Knowledge transfer & documentation','task',162,175,'TT6',[]),
          t('TT6A3','Transition to BAU','task',176,182,'TT6',['TT6A1','TT6A2']),
          t('TT6M','Project closure','milestone',182,182,'TT6',['TT6A3']),
        ];
      },

      'operating-model': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('OM1','Phase 1 â€” Diagnostic & Baselining','phase',0,27,null,[],1),
          t('OM1A','Organisational Assessment','activity',0,13,'OM1',[],1),
          t('OM1A1','Stakeholder interviews & surveys','task',0,6,'OM1A',[]),
          t('OM1A2','Current operating model documentation','task',7,13,'OM1A',['OM1A1']),
          t('OM1B','Process & Capability Mapping','activity',10,25,'OM1',[],1),
          t('OM1B1','Process landscape mapping','task',10,17,'OM1B',[]),
          t('OM1B2','Capability maturity assessment','task',18,25,'OM1B',['OM1B1']),
          t('OM1M','Diagnostic complete','milestone',27,27,'OM1',['OM1A2','OM1B2']),

          t('OM2','Phase 2 â€” Target Operating Model Design','phase',28,69,null,['OM1M'],1),
          t('OM2A','Design Development','activity',28,55,'OM2',[],1),
          t('OM2A1','Target operating model design','task',28,42,'OM2A',[]),
          t('OM2A2','Process redesign & optimisation','task',43,52,'OM2A',['OM2A1']),
          t('OM2A3','Governance framework design','task',48,55,'OM2A',[]),
          t('OM2B','Validation','activity',56,67,'OM2',[],1),
          t('OM2B1','Stakeholder review workshops','task',56,62,'OM2B',['OM2A2','OM2A3']),
          t('OM2B2','Business case finalisation','task',63,67,'OM2B',['OM2B1']),
          t('OM2M','Design approved','milestone',69,69,'OM2',['OM2B2']),

          t('OM3','Phase 3 â€” Implementation','phase',70,111,null,['OM2M'],1),
          t('OM3A1','Organisational restructuring','task',70,84,'OM3',[]),
          t('OM3A2','Process implementation','task',78,97,'OM3',[]),
          t('OM3A3','Technology enablement','task',85,104,'OM3',[]),
          t('OM3A4','Change management & communications','task',70,111,'OM3',[]),
          t('OM3M','Implementation complete','milestone',111,111,'OM3',['OM3A1','OM3A2','OM3A3']),

          t('OM4','Phase 4 â€” Embed & Benefits Realisation','phase',112,139,null,['OM3M'],1),
          t('OM4A1','Adoption monitoring & coaching','task',112,125,'OM4',[]),
          t('OM4A2','Performance measurement','task',119,132,'OM4',[]),
          t('OM4A3','Continuous improvement planning','task',133,139,'OM4',['OM4A1','OM4A2']),
          t('OM4M','Transition to BAU','milestone',139,139,'OM4',['OM4A3']),
        ];
      },

      'ma-integration': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('MA1','Phase 1 â€” Due Diligence','phase',0,34,null,[],1),
          t('MA1A','Financial & Commercial Analysis','activity',0,20,'MA1',[],1),
          t('MA1A1','Financial model review','task',0,10,'MA1A',[]),
          t('MA1A2','Commercial due diligence','task',7,17,'MA1A',[]),
          t('MA1A3','Synergy identification','task',14,20,'MA1A',['MA1A1']),
          t('MA1B','Operational Assessment','activity',10,32,'MA1',[],1),
          t('MA1B1','Operational due diligence','task',10,22,'MA1B',[]),
          t('MA1B2','Cultural assessment','task',20,30,'MA1B',[]),
          t('MA1B3','Risk assessment & mitigation','task',25,32,'MA1B',['MA1B1']),
          t('MA1M','Due diligence complete','milestone',34,34,'MA1',['MA1A3','MA1B3']),

          t('MA2','Phase 2 â€” Day 1 Planning','phase',35,62,null,['MA1M'],1),
          t('MA2A1','Integration strategy & governance','task',35,44,'MA2',[]),
          t('MA2A2','Day 1 readiness planning','task',42,55,'MA2',['MA2A1']),
          t('MA2A3','Communications & stakeholder plan','task',45,60,'MA2',[]),
          t('MA2M','Day 1 ready','milestone',62,62,'MA2',['MA2A2','MA2A3']),

          t('MA3','Phase 3 â€” Integration Execution','phase',63,132,null,['MA2M'],1),
          t('MA3A','Functional Integration','activity',63,104,'MA3',[],1),
          t('MA3A1','Finance & HR integration','task',63,83,'MA3A',[]),
          t('MA3A2','Operations & supply chain alignment','task',70,97,'MA3A',[]),
          t('MA3A3','IT systems integration','task',77,104,'MA3A',[]),
          t('MA3B','People Integration','activity',63,125,'MA3',[],1),
          t('MA3B1','Organisation design & role mapping','task',63,83,'MA3B',[]),
          t('MA3B2','Cultural integration programme','task',77,118,'MA3B',['MA3B1']),
          t('MA3B3','Retention & engagement initiatives','task',84,125,'MA3B',[]),
          t('MA3M','Integration substantially complete','milestone',132,132,'MA3',['MA3A3','MA3B3']),

          t('MA4','Phase 4 â€” Synergy Tracking & Optimisation','phase',133,167,null,['MA3M'],1),
          t('MA4A1','Synergy tracking & reporting','task',133,153,'MA4',[]),
          t('MA4A2','Value realisation assessment','task',147,160,'MA4',['MA4A1']),
          t('MA4A3','Transition to BAU operations','task',155,167,'MA4',['MA4A2']),
          t('MA4M','Integration closure','milestone',167,167,'MA4',['MA4A3']),
        ];
      },

      'finance-transformation': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('FT1','Phase 1 â€” Current State Assessment','phase',0,20,null,[],1),
          t('FT1A1','Process documentation & analysis','task',0,10,'FT1',[]),
          t('FT1A2','Systems & data landscape review','task',5,15,'FT1',[]),
          t('FT1A3','Pain point identification & prioritisation','task',12,20,'FT1',['FT1A1']),
          t('FT1M','Assessment complete','milestone',20,20,'FT1',['FT1A3','FT1A2']),

          t('FT2','Phase 2 â€” Target State Design','phase',21,48,null,['FT1M'],1),
          t('FT2A','Design','activity',21,42,'FT2',[],1),
          t('FT2A1','Future state process design','task',21,32,'FT2A',[]),
          t('FT2A2','Technology selection & architecture','task',28,38,'FT2A',[]),
          t('FT2A3','Business case development','task',35,42,'FT2A',['FT2A1','FT2A2']),
          t('FT2M','Design approved','milestone',48,48,'FT2',['FT2A3']),

          t('FT3','Phase 3 â€” Process & System Implementation','phase',49,104,null,['FT2M'],1),
          t('FT3A','Build','activity',49,90,'FT3',[],1),
          t('FT3A1','Process re-engineering','task',49,65,'FT3A',[]),
          t('FT3A2','System configuration & customisation','task',56,83,'FT3A',[]),
          t('FT3A3','Data cleansing & migration','task',70,90,'FT3A',['FT3A1']),
          t('FT3B','Enablement','activity',77,102,'FT3',[],1),
          t('FT3B1','Training material development','task',77,88,'FT3B',[]),
          t('FT3B2','End user training delivery','task',89,102,'FT3B',['FT3B1']),
          t('FT3M','Build complete','milestone',104,104,'FT3',['FT3A3','FT3B2']),

          t('FT4','Phase 4 â€” UAT & Validation','phase',105,132,null,['FT3M'],1),
          t('FT4A1','Integration testing','task',105,115,'FT4',[]),
          t('FT4A2','User acceptance testing','task',116,126,'FT4',['FT4A1']),
          t('FT4A3','Parallel running & reconciliation','task',120,132,'FT4',[]),
          t('FT4M','Testing sign-off','milestone',132,132,'FT4',['FT4A2','FT4A3']),

          t('FT5','Phase 5 â€” Go-Live & Stabilisation','phase',133,153,null,['FT4M'],1),
          t('FT5A1','Cutover planning & execution','task',133,140,'FT5',[]),
          t('FT5A2','Go-live support','task',141,148,'FT5',['FT5A1']),
          t('FT5A3','Stabilisation & handover','task',149,153,'FT5',['FT5A2']),
          t('FT5M','Project closure','milestone',153,153,'FT5',['FT5A3']),
        ];
      },

      'cyber-assessment': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('CY1','Phase 1 â€” Scoping & Planning','phase',0,13,null,[],1),
          t('CY1A1','Scope definition & objectives','task',0,4,'CY1',[]),
          t('CY1A2','Asset inventory & classification','task',3,9,'CY1',[]),
          t('CY1A3','Assessment methodology & planning','task',7,13,'CY1',['CY1A1']),
          t('CY1M','Scoping complete','milestone',13,13,'CY1',['CY1A2','CY1A3']),

          t('CY2','Phase 2 â€” Assessment & Testing','phase',14,48,null,['CY1M'],1),
          t('CY2A','Vulnerability Assessment','activity',14,30,'CY2',[],1),
          t('CY2A1','Automated vulnerability scanning','task',14,20,'CY2A',[]),
          t('CY2A2','Configuration review','task',18,25,'CY2A',[]),
          t('CY2A3','Code review & static analysis','task',21,30,'CY2A',['CY2A1']),
          t('CY2B','Threat Analysis','activity',25,46,'CY2',[],1),
          t('CY2B1','Penetration testing','task',25,38,'CY2B',[]),
          t('CY2B2','Social engineering assessment','task',32,40,'CY2B',[]),
          t('CY2B3','Risk scoring & prioritisation','task',39,46,'CY2B',['CY2B1','CY2B2']),
          t('CY2M','Assessment complete','milestone',48,48,'CY2',['CY2A3','CY2B3']),

          t('CY3','Phase 3 â€” Remediation Planning','phase',49,76,null,['CY2M'],1),
          t('CY3A1','Remediation roadmap development','task',49,58,'CY3',[]),
          t('CY3A2','Quick wins implementation','task',55,66,'CY3',['CY3A1']),
          t('CY3A3','Strategic remediation execution','task',60,76,'CY3',['CY3A1']),
          t('CY3M','Remediation complete','milestone',76,76,'CY3',['CY3A2','CY3A3']),

          t('CY4','Phase 4 â€” Validation & Assurance','phase',77,97,null,['CY3M'],1),
          t('CY4A1','Re-testing & validation','task',77,85,'CY4',[]),
          t('CY4A2','Compliance review','task',83,90,'CY4',['CY4A1']),
          t('CY4A3','Final assurance report','task',88,95,'CY4',['CY4A2']),
          t('CY4M','Assurance sign-off','milestone',97,97,'CY4',['CY4A3']),
        ];
      },

      'people-change': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('PC1','Phase 1 â€” Organisational Analysis','phase',0,27,null,[],1),
          t('PC1A','Assessment','activity',0,20,'PC1',[],1),
          t('PC1A1','Stakeholder analysis & mapping','task',0,7,'PC1A',[]),
          t('PC1A2','Change impact assessment','task',5,14,'PC1A',[]),
          t('PC1A3','Organisational readiness assessment','task',12,20,'PC1A',['PC1A1']),
          t('PC1M','Analysis complete','milestone',27,27,'PC1',['PC1A3','PC1A2']),

          t('PC2','Phase 2 â€” Future State Design','phase',28,55,null,['PC1M'],1),
          t('PC2A1','Change strategy development','task',28,38,'PC2',[]),
          t('PC2A2','Communication plan design','task',35,45,'PC2',['PC2A1']),
          t('PC2A3','Training needs analysis & design','task',39,52,'PC2',['PC2A1']),
          t('PC2M','Design approved','milestone',55,55,'PC2',['PC2A2','PC2A3']),

          t('PC3','Phase 3 â€” Engagement & Communication','phase',56,97,null,['PC2M'],1),
          t('PC3A','Rollout','activity',56,90,'PC3',[],1),
          t('PC3A1','Leadership alignment & sponsorship','task',56,66,'PC3A',[]),
          t('PC3A2','Communication campaign rollout','task',60,83,'PC3A',['PC3A1']),
          t('PC3A3','Training programme delivery','task',67,90,'PC3A',['PC3A1']),
          t('PC3M','Rollout complete','milestone',97,97,'PC3',['PC3A2','PC3A3']),

          t('PC4','Phase 4 â€” Embed & Sustain','phase',98,125,null,['PC3M'],1),
          t('PC4A1','Adoption monitoring & reinforcement','task',98,111,'PC4',[]),
          t('PC4A2','Feedback loops & coaching','task',105,118,'PC4',[]),
          t('PC4A3','Sustainability planning & handover','task',116,125,'PC4',['PC4A1','PC4A2']),
          t('PC4M','Change embedded','milestone',125,125,'PC4',['PC4A3']),
        ];
      },

      'data-analytics': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('DA1','Phase 1 â€” Discovery & Data Landscape','phase',0,27,null,[],1),
          t('DA1A','Data Assessment','activity',0,18,'DA1',[],1),
          t('DA1A1','Data landscape & inventory','task',0,8,'DA1A',[]),
          t('DA1A2','Data quality assessment','task',6,14,'DA1A',[]),
          t('DA1A3','Use case identification & prioritisation','task',12,18,'DA1A',['DA1A1']),
          t('DA1B','Stakeholder Alignment','activity',10,25,'DA1',[],1),
          t('DA1B1','Business requirements gathering','task',10,17,'DA1B',[]),
          t('DA1B2','Analytics maturity assessment','task',18,25,'DA1B',['DA1B1']),
          t('DA1M','Discovery complete','milestone',27,27,'DA1',['DA1A3','DA1B2']),

          t('DA2','Phase 2 â€” Architecture & Roadmap','phase',28,62,null,['DA1M'],1),
          t('DA2A1','Data architecture design','task',28,40,'DA2',[]),
          t('DA2A2','Technology platform selection','task',35,48,'DA2',['DA2A1']),
          t('DA2A3','Data governance framework','task',42,55,'DA2',[]),
          t('DA2A4','Implementation roadmap','task',50,60,'DA2',['DA2A2','DA2A3']),
          t('DA2M','Architecture approved','milestone',62,62,'DA2',['DA2A4']),

          t('DA3','Phase 3 â€” Platform Build & Integration','phase',63,111,null,['DA2M'],1),
          t('DA3A','Build','activity',63,97,'DA3',[],1),
          t('DA3A1','Data platform provisioning','task',63,73,'DA3A',[]),
          t('DA3A2','Data pipeline development','task',74,90,'DA3A',['DA3A1']),
          t('DA3A3','Data quality implementation','task',84,97,'DA3A',['DA3A1']),
          t('DA3B','Analytics','activity',84,109,'DA3',[],1),
          t('DA3B1','Dashboard & reporting development','task',84,97,'DA3B',[]),
          t('DA3B2','Advanced analytics & ML models','task',91,109,'DA3B',['DA3B1']),
          t('DA3M','Build complete','milestone',111,111,'DA3',['DA3A3','DA3B2']),

          t('DA4','Phase 4 â€” Deployment & Enablement','phase',112,139,null,['DA3M'],1),
          t('DA4A1','Platform deployment & go-live','task',112,120,'DA4',[]),
          t('DA4A2','User onboarding & training','task',118,130,'DA4',['DA4A1']),
          t('DA4A3','Operational handover & support model','task',128,139,'DA4',['DA4A2']),
          t('DA4M','Project closure','milestone',139,139,'DA4',['DA4A3']),
        ];
      },

      'regulatory-compliance': function(){
        const d = todayIso();
        const t = (id,name,type,s,e,pid,deps,ro) => ({id,name,type,start:addDays(d,s),end:addDays(d,e),parentId:pid,dependencies:deps,rollup:!!ro,locked:false,collapsed:false});
        return [
          t('RC1','Phase 1 â€” Gap Analysis & Scoping','phase',0,27,null,[],1),
          t('RC1A1','Regulatory landscape review','task',0,8,'RC1',[]),
          t('RC1A2','Current state compliance assessment','task',5,15,'RC1',[]),
          t('RC1A3','Gap identification & prioritisation','task',13,25,'RC1',['RC1A1','RC1A2']),
          t('RC1M','Gap analysis complete','milestone',27,27,'RC1',['RC1A3']),

          t('RC2','Phase 2 â€” Controls Design','phase',28,55,null,['RC1M'],1),
          t('RC2A1','Compliance framework design','task',28,38,'RC2',[]),
          t('RC2A2','Control design & specification','task',35,48,'RC2',['RC2A1']),
          t('RC2A3','Policy & procedure development','task',42,55,'RC2',['RC2A1']),
          t('RC2M','Design complete','milestone',55,55,'RC2',['RC2A2','RC2A3']),

          t('RC3','Phase 3 â€” Implementation & Remediation','phase',56,111,null,['RC2M'],1),
          t('RC3A','Implementation','activity',56,97,'RC3',[],1),
          t('RC3A1','Control implementation','task',56,76,'RC3A',[]),
          t('RC3A2','Process & system changes','task',63,90,'RC3A',[]),
          t('RC3A3','Training & awareness programme','task',77,97,'RC3A',['RC3A1']),
          t('RC3M','Implementation complete','milestone',111,111,'RC3',['RC3A1','RC3A2','RC3A3']),

          t('RC4','Phase 4 â€” Testing & Evidence','phase',112,139,null,['RC3M'],1),
          t('RC4A1','Control testing & effectiveness review','task',112,125,'RC4',[]),
          t('RC4A2','Evidence collection & documentation','task',118,132,'RC4',['RC4A1']),
          t('RC4A3','Compliance validation','task',130,139,'RC4',['RC4A2']),
          t('RC4M','Testing complete','milestone',139,139,'RC4',['RC4A3']),

          t('RC5','Phase 5 â€” Assurance & Reporting','phase',140,153,null,['RC4M'],1),
          t('RC5A1','Independent assurance review','task',140,148,'RC5',[]),
          t('RC5A2','Final compliance report','task',146,153,'RC5',['RC5A1']),
          t('RC5M','Programme closure','milestone',153,153,'RC5',['RC5A2']),
        ];
      }
    };

    // ======= Scenario loader =======
    document.getElementById('btnLoadScenario').addEventListener('click', () => {
      const key = document.getElementById('scenarioSelect').value;
      if(!key || !SCENARIOS[key]) return;
      if(state.tasks.length > 0 && !confirm('This will replace your current project plan. Continue?')) return;
      state.tasks = SCENARIOS[key]();
      state.selectedId = null;
      render();
    });

    // ======= Seed data =======
    function seed(){
      const d = todayIso();
      state.tasks = [
        { id:'P1', name:'Phase 1 â€” Discovery', type:'phase', start:addDays(d,0), end:addDays(d,14), parentId:null, dependencies:[], rollup:true, locked:false, collapsed:false },
        { id:'A11', name:'Activity â€” Stakeholder workshops', type:'activity', start:addDays(d,0), end:addDays(d,5), parentId:'P1', dependencies:[], rollup:true, locked:false, collapsed:false },
        { id:'T111', name:'Workshop prep', type:'task', start:addDays(d,0), end:addDays(d,1), parentId:'A11', dependencies:[], rollup:false, locked:false, collapsed:false },
        { id:'T112', name:'Run workshops', type:'task', start:addDays(d,2), end:addDays(d,4), parentId:'A11', dependencies:['T111'], rollup:false, locked:false, collapsed:false },
        { id:'M113', name:'Discovery sign-off', type:'milestone', start:addDays(d,5), end:addDays(d,5), parentId:'A11', dependencies:['T112'], rollup:false, locked:false, collapsed:false },

        { id:'A12', name:'Activity â€” Current state analysis', type:'activity', start:addDays(d,3), end:addDays(d,13), parentId:'P1', dependencies:['M113'], rollup:true, locked:false, collapsed:false },
        { id:'T121', name:'Data gathering', type:'task', start:addDays(d,3), end:addDays(d,7), parentId:'A12', dependencies:[], rollup:false, locked:false, collapsed:false },
        { id:'T122', name:'Analysis & findings', type:'task', start:addDays(d,8), end:addDays(d,13), parentId:'A12', dependencies:['T121'], rollup:false, locked:false, collapsed:false },

        { id:'P2', name:'Phase 2 â€” Delivery', type:'phase', start:addDays(d,15), end:addDays(d,35), parentId:null, dependencies:['M113'], rollup:true, locked:false, collapsed:false },
        { id:'T21', name:'Build solution', type:'task', start:addDays(d,15), end:addDays(d,30), parentId:'P2', dependencies:['T122'], rollup:false, locked:false, collapsed:false },
        { id:'M22', name:'Go-live', type:'milestone', start:addDays(d,35), end:addDays(d,35), parentId:'P2', dependencies:['T21'], rollup:false, locked:false, collapsed:false },
      ];
    }

    // ======= Boot =======
    function syncSliders(){
      zoom.value = String(state.config.dayWidth);
      zoomVal.textContent = zoom.value;
      leftWidth.value = String(state.config.leftWidth);
      leftWidthVal.textContent = leftWidth.value;
    }

    (function init(){
      // initial config from sliders
      state.config.dayWidth = Number(zoom.value);
      state.config.leftWidth = Number(leftWidth.value);
      zoomVal.textContent = zoom.value;
      leftWidthVal.textContent = leftWidth.value;

      // load saved if present; try migration from old key; else seed
      const raw = localStorage.getItem(STORAGE_KEY);
      const oldRaw = !raw ? localStorage.getItem('offline_gantt_builder_v1') : null;
      const data = raw || oldRaw;
      if(data){
        try{
          const obj = JSON.parse(data);
          if(obj && Array.isArray(obj.tasks)){
            state.tasks = obj.tasks;
            if(obj.config && typeof obj.config === 'object'){
              state.config = {...state.config, ...obj.config};
            }
            syncSliders();
          } else {
            seed();
          }
        } catch {
          seed();
        }
      } else {
        seed();
      }

      // toolbar add also opens modal
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && modalBackdrop.classList.contains('open')) closeModal();
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
          e.preventDefault();
          saveLocal();
        }
      });

      render();
    })();

  </script>
</body>
</html>
